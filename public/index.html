<!DOCTYPE html>
<html>
<head>
  <title>YouTube Downloader</title>
  <style>
    body { background: #121212; color: #fff; font-family: Arial; padding: 20px; }
    input, button, select { padding: 8px; margin: 5px; }
    .video-list { display: flex; flex-wrap: wrap; gap: 20px; }
    .video-card {
      background: #1e1e1e; border-radius: 10px; width: 320px;
      overflow: hidden; box-shadow: 0 0 5px #000;
    }
    .video-card img { width: 100%; }
    .video-info { padding: 10px; }
    small { color: #aaa; display: block; }
    .controls { margin-top: 10px; }
  </style>
</head>
<body>

<h2>YouTube Downloader</h2>
<input type="text" id="query" placeholder="Search or paste YouTube URL" size="40">
<button onclick="handleSearch()">Search</button>

<div id="videos" class="video-list"></div>

<script>
function handleSearch() {
  const query = document.getElementById('query').value;
  const isUrl = query.includes("youtube.com") || query.includes("youtu.be");

  if (isUrl) {
    fetchFormats(query);
  } else {
    fetch(`/api/search?q=${encodeURIComponent(query)}`)
      .then(res => res.json())
      .then(renderVideos);
  }
}

function fetchFormats(url) {
  fetch(`/api/formats?url=${encodeURIComponent(url)}`)
    .then(res => res.json())
    .then(data => {
      const vOpts = data.video.map(f =>
        `<option value="${f.itag}">${f.qualityLabel || 'Unknown'} (${Math.round((f.contentLength || 0)/1024/1024) || '?'} MB)</option>`
      ).join('');

      const aOpts = data.audio.map(f =>
        `<option value="${f.itag}">Audio ${f.audioBitrate}kbps</option>`
      ).join('');

      document.getElementById('videos').innerHTML = `
        <div class="video-card">
          <div class="video-info">
            <strong>${data.title}</strong><br><br>
            <label>Video Quality</label><br>
            <select id="vformat">${vOpts}</select>
            <a id="vdl" target="_blank"><button>Download Video</button></a><br><br>

            <label>Audio Only</label><br>
            <select id="aformat">${aOpts}</select>
            <a id="adl" target="_blank"><button>Download Audio</button></a><br><br>

            <button onclick="playPreview('${url}')">Play Preview</button>
          </div>
        </div>
      `;

      const vSel = document.getElementById('vformat');
      const aSel = document.getElementById('aformat');
      const vBtn = document.getElementById('vdl');
      const aBtn = document.getElementById('adl');

      function updateLinks() {
        vBtn.href = `/api/download?url=${encodeURIComponent(url)}&itag=${vSel.value}`;
        aBtn.href = `/api/download?url=${encodeURIComponent(url)}&itag=${aSel.value}`;
      }

      vSel.onchange = updateLinks;
      aSel.onchange = updateLinks;
      updateLinks();
    })
    .catch(() => alert("Video not available or restricted"));
}

function renderVideos(videos) {
  const container = document.getElementById('videos');
  container.innerHTML = videos.map(v => `
    <div class="video-card">
      <img src="${v.thumbnail}">
      <div class="video-info">
        <strong>${v.title}</strong>
        <small>${v.channel}</small>
        <small>Views: ${v.views}</small>
        <small>Likes: ${v.likes}</small>
        <button onclick="fetchFormats('https://www.youtube.com/watch?v=${v.id}')">Download</button>
      </div>
    </div>
  `).join('');
}

function playPreview(url) {
  const id = new URL(url).searchParams.get("v") || url.split("v=")[1]?.split("&")[0];
  window.open(`https://www.youtube.com/embed/${id}`, '_blank');
}

// Auto-fetch trending
window.onload = () => {
  fetch('/api/search').then(res => res.json()).then(renderVideos);
};
</script>

</body>
</html>
