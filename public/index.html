<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>YouTube Player + Downloader</title>
  <style>
    body { font-family: Arial; padding: 20px; background: #f4f4f4; }
    input, button, select { padding: 10px; margin: 5px; }
    iframe { margin-top: 20px; width: 100%; max-width: 640px; height: 360px; }
    .results img { width: 120px; }
    .results div { margin: 10px 0; }
  </style>
</head>
<body>
  <h1>YouTube Player + Downloader</h1>

  <input type="text" id="input" placeholder="Search or paste URL" size="50">
  <button onclick="handleSearch()">Go</button>

  <div id="video-container"></div>
  <div id="formats"></div>
  <div class="results"></div>

  <script>
    async function handleSearch() {
      const input = document.getElementById('input').value;
      const resultsDiv = document.querySelector('.results');
      const formatsDiv = document.getElementById('formats');
      const videoDiv = document.getElementById('video-container');
      resultsDiv.innerHTML = '';
      formatsDiv.innerHTML = '';
      videoDiv.innerHTML = '';

      if (input.includes('youtube.com/watch') || input.includes('youtu.be/')) {
        const url = input;
        const videoId = extractVideoID(url);
        if (videoId) {
          showPlayer(videoId);
          showFormats(url);
        }
      } else {
        const res = await fetch(`/api/search?q=${encodeURIComponent(input)}`);
        const data = await res.json();

        data.forEach(video => {
          const div = document.createElement('div');
          div.innerHTML = `
            <img src="${video.thumbnail}"> <strong>${video.title}</strong><br>
            <button onclick="selectVideo('${video.videoId}')">Play</button>
          `;
          resultsDiv.appendChild(div);
        });
      }
    }

    function extractVideoID(url) {
      const match = url.match(/(?:v=|\/)([0-9A-Za-z_-]{11})/);
      return match ? match[1] : null;
    }

    function selectVideo(videoId) {
      const url = `https://www.youtube.com/watch?v=${videoId}`;
      document.getElementById('input').value = url;
      showPlayer(videoId);
      showFormats(url);
    }

    function showPlayer(videoId) {
      document.getElementById('video-container').innerHTML = `
        <iframe src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe>
      `;
    }

    async function showFormats(url) {
      const res = await fetch(`/api/formats?url=${encodeURIComponent(url)}`);
      const data = await res.json();
      const formatsDiv = document.getElementById('formats');

      if (!data.formats.length) {
        formatsDiv.innerHTML = "<p>No downloadable formats found.</p>";
        return;
      }

      formatsDiv.innerHTML = `<h3>Download "${data.title}"</h3>`;
      data.formats.forEach(f => {
        const link = document.createElement('a');
        link.href = `/api/download?url=${encodeURIComponent(url)}&itag=${f.itag}`;
        link.textContent = `Download ${f.quality}`;
        link.style.marginRight = '10px';
        link.style.display = 'inline-block';
        link.target = '_blank';
        formatsDiv.appendChild(link);
      });
    }
  </script>
</body>
</html>
