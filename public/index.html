<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>YouTube Player & Downloader</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    input, button, select { padding: 10px; margin: 5px; }
    #videoPlayer { margin-top: 20px; display: none; }
  </style>
</head>
<body>
  <h2>YouTube Video Downloader</h2>
  <input type="text" id="videoInput" placeholder="Search or paste YouTube URL" size="50">
  <button onclick="handleInput()">Fetch</button>

  <div id="videoPlayer">
    <h3 id="videoTitle"></h3>
    <iframe id="ytPlayer" width="560" height="315" frameborder="0" allowfullscreen></iframe>

    <div>
      <label>Select quality:</label>
      <select id="formatSelect"></select>
      <button onclick="download()">Download</button>
    </div>
  </div>

  <script>
    let currentUrl = "";

    async function handleInput() {
      const input = document.getElementById('videoInput').value.trim();
      if (!input) return alert("Enter a search term or YouTube URL.");

      // If it's a URL, use it directly
      let url = input;
      if (!input.startsWith("http")) {
        // Perform search
        const res = await fetch(`/api/search?q=${encodeURIComponent(input)}`);
        const videos = await res.json();
        if (!videos.length) return alert("No results.");
        url = videos[0].url;
      }

      currentUrl = url;
      loadFormats(url);
    }

    async function loadFormats(url) {
      const res = await fetch(`/api/formats?url=${encodeURIComponent(url)}`);
      const data = await res.json();

      if (!data.formats || !data.formats.length) {
        return alert("No downloadable formats found.");
      }

      document.getElementById("videoPlayer").style.display = "block";
      document.getElementById("videoTitle").innerText = data.title;
      document.getElementById("ytPlayer").src = "https://www.youtube.com/embed/" + new URL(url).searchParams.get("v");

      const select = document.getElementById("formatSelect");
      select.innerHTML = "";
      data.formats.forEach(f => {
        const option = document.createElement("option");
        option.value = f.itag;
        option.innerText = `${f.quality} (${f.size})`;
        select.appendChild(option);
      });
    }

    function download() {
      const itag = document.getElementById("formatSelect").value;
      const url = `/api/download?url=${encodeURIComponent(currentUrl)}&itag=${itag}`;
      window.open(url, "_blank");
    }
  </script>
</body>
</html>
